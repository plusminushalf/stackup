"use strict";(self.webpackChunk_stackupfinance_docs=self.webpackChunk_stackupfinance_docs||[]).push([[122],{3905:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>u});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),d=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},s=function(e){var t=d(e.components);return a.createElement(p.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),c=d(n),u=r,k=c["".concat(p,".").concat(u)]||c[u]||m[u]||i;return n?a.createElement(k,o(o({ref:t},s),{},{components:n})):a.createElement(k,o({ref:t},s))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=c;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var d=2;d<i;d++)o[d]=n[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},1135:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>p,default:()=>u,frontMatter:()=>l,metadata:()=>d,toc:()=>m});var a=n(7896),r=n(1461),i=(n(7294),n(3905)),o=["components"],l={sidebar_position:2},p="ERC-4337 Overview",d={unversionedId:"introduction/erc-4337-overview",id:"introduction/erc-4337-overview",title:"ERC-4337 Overview",description:"A quick overview of the standard for developers.",source:"@site/docs/introduction/erc-4337-overview.md",sourceDirName:"introduction",slug:"/introduction/erc-4337-overview",permalink:"/docs/introduction/erc-4337-overview",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/introduction/erc-4337-overview.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Account Abstraction",permalink:"/docs/introduction/account-abstraction"},next:{title:"More Resources",permalink:"/docs/introduction/more-resources"}},s={},m=[{value:"Introduction",id:"introduction",level:2},{value:"UserOperation",id:"useroperation",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Bundler",id:"bundler",level:3},{value:"EntryPoint",id:"entrypoint",level:3},{value:"Wallet",id:"wallet",level:3},{value:"Paymaster",id:"paymaster",level:3}],c={toc:m};function u(e){var t=e.components,l=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},c,l,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"erc-4337-overview"},"ERC-4337 Overview"),(0,i.kt)("p",null,"A quick overview of the standard for developers."),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},"This EIP is expected to include updates in future iterations.")),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("p",null,"This page gives a simplified overview of ERC-4337 so that developers can get a basic understanding of the different components and how they can be pieced together to build their applications. ",(0,i.kt)("strong",{parentName:"p"},"For a full run down on the spec we recommend going straight to the ",(0,i.kt)("a",{parentName:"strong",href:"https://eips.ethereum.org/EIPS/eip-4337"},"source"),".")),(0,i.kt)("h2",{id:"useroperation"},"UserOperation"),(0,i.kt)("p",null,"All components of ERC-4337 revolve around a pseudo-transaction object called a ",(0,i.kt)("inlineCode",{parentName:"p"},"UserOperation")," which is ",(0,i.kt)("strong",{parentName:"p"},"used to execute actions through a smart contract wallet"),". This isn't to be mistaken for a regular transaction type."),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Field"),(0,i.kt)("th",{parentName:"tr",align:null},"Type"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"sender")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"address")),(0,i.kt)("td",{parentName:"tr",align:null},"The address of the smart contract wallet")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"nonce")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"uint256")),(0,i.kt)("td",{parentName:"tr",align:null},"Anti-replay protection")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"initCode")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"bytes")),(0,i.kt)("td",{parentName:"tr",align:null},"Code used to deploy the wallet if not yet on-chain")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"callData")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"bytes")),(0,i.kt)("td",{parentName:"tr",align:null},"Data that's passed to the ",(0,i.kt)("inlineCode",{parentName:"td"},"sender")," for execution")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"callGas")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"uint256")),(0,i.kt)("td",{parentName:"tr",align:null},"Gas limit for execution step")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"verificationGas")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"uint256")),(0,i.kt)("td",{parentName:"tr",align:null},"Gas limit for verification step")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"preVerificationGas")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"uint256")),(0,i.kt)("td",{parentName:"tr",align:null},"Gas to compensate the bundler")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"maxFeePerGas")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"uint256")),(0,i.kt)("td",{parentName:"tr",align:null},"Similar to EIP-1559 max fee")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"maxPriorityFeePerGas")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"uint256")),(0,i.kt)("td",{parentName:"tr",align:null},"Similar to EIP-1559 priority fee")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"paymaster")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"address")),(0,i.kt)("td",{parentName:"tr",align:null},"The address sponsoring the transaction")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"paymasterData")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"bytes")),(0,i.kt)("td",{parentName:"tr",align:null},"Data to be sent to ",(0,i.kt)("inlineCode",{parentName:"td"},"paymaster"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"signature")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"bytes")),(0,i.kt)("td",{parentName:"tr",align:null},"Used to validate a ",(0,i.kt)("inlineCode",{parentName:"td"},"UserOperation")," along with the ",(0,i.kt)("inlineCode",{parentName:"td"},"nonce")," during verification")))),(0,i.kt)("h2",{id:"architecture"},"Architecture"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"ERC-4337 Architecture Simplified",src:n(7095).Z,width:"1129",height:"351"})),(0,i.kt)("p",null,"Although highly simplified, the above diagram shows the interactions between all the different components of the standard. We'll get into details of each component below, but on a high level a ",(0,i.kt)("inlineCode",{parentName:"p"},"UserOperation")," has the following life cycle."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"A ",(0,i.kt)("inlineCode",{parentName:"li"},"UserOperation")," is created in your app and signed by the user."),(0,i.kt)("li",{parentName:"ol"},"The ",(0,i.kt)("inlineCode",{parentName:"li"},"UserOperation")," is sent to a dedicated mempool."),(0,i.kt)("li",{parentName:"ol"},"A ",(0,i.kt)("inlineCode",{parentName:"li"},"Bundler")," batches multiple ",(0,i.kt)("inlineCode",{parentName:"li"},"UserOperations")," from the mempool and relays them to the ",(0,i.kt)("inlineCode",{parentName:"li"},"EntryPoint"),"."),(0,i.kt)("li",{parentName:"ol"},"The ",(0,i.kt)("inlineCode",{parentName:"li"},"EntryPoint")," coordinates the verification and execution of the ",(0,i.kt)("inlineCode",{parentName:"li"},"UserOperation")," via the ",(0,i.kt)("inlineCode",{parentName:"li"},"Wallet")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"Paymaster"),".")),(0,i.kt)("h3",{id:"bundler"},"Bundler"),(0,i.kt)("p",null,"A ",(0,i.kt)("inlineCode",{parentName:"p"},"Bundler")," is a class of actors that can do several things:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Listen in to a ",(0,i.kt)("inlineCode",{parentName:"li"},"UserOperation")," mempool."),(0,i.kt)("li",{parentName:"ul"},"Runs simulations."),(0,i.kt)("li",{parentName:"ul"},"Bundles an array of operations."),(0,i.kt)("li",{parentName:"ul"},"Relays bundles to the ",(0,i.kt)("inlineCode",{parentName:"li"},"EntryPoint"),".")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"The dedicated ",(0,i.kt)("inlineCode",{parentName:"p"},"UserOperation")," mempool is separate and not to be confused with the regular transaction mempool.")),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},"Although a public P2P ",(0,i.kt)("inlineCode",{parentName:"p"},"UserOperation")," mempool is still a work in progress, the advantages of account abstraction can still be leveraged today by relying on private mempools that anyone can spin up.")),(0,i.kt)("h3",{id:"entrypoint"},"EntryPoint"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"EntryPoint")," is a contract that acts as a central entity for all ERC-4337 wallets and paymasters. It coordinates the verification and execution of a ",(0,i.kt)("inlineCode",{parentName:"p"},"UserOperation"),". For this reason, it's important for all implementations of an ",(0,i.kt)("inlineCode",{parentName:"p"},"EntryPoint")," to be audited and not controllable by any single entity."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"ERC-4337 EntryPoint Sequence",src:n(2876).Z,width:"1174",height:"1236"})),(0,i.kt)("p",null,"The above sequence diagram shows how the ",(0,i.kt)("inlineCode",{parentName:"p"},"EntryPoint")," handles a batch of ",(0,i.kt)("inlineCode",{parentName:"p"},"UserOperations")," sent by the ",(0,i.kt)("inlineCode",{parentName:"p"},"Bundler"),". Essentially there are 2 phases."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Verification loop"),": Verifies that each ",(0,i.kt)("inlineCode",{parentName:"li"},"UserOperation")," is valid by checking it with both the ",(0,i.kt)("inlineCode",{parentName:"li"},"Wallet")," and the ",(0,i.kt)("inlineCode",{parentName:"li"},"Paymaster"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Execution loop"),": Sends the ",(0,i.kt)("inlineCode",{parentName:"li"},"callData")," in each ",(0,i.kt)("inlineCode",{parentName:"li"},"UserOperation")," to the ",(0,i.kt)("inlineCode",{parentName:"li"},"Wallet"),".")),(0,i.kt)("p",null,"The verification loop will also make sure that either the ",(0,i.kt)("inlineCode",{parentName:"p"},"Wallet")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"Paymaster")," can pay the maximum gas cost for each ",(0,i.kt)("inlineCode",{parentName:"p"},"UserOperation"),". In the execution loop any unused gas fee is refunded to the ",(0,i.kt)("inlineCode",{parentName:"p"},"Wallet")," or a function is called on the ",(0,i.kt)("inlineCode",{parentName:"p"},"Paymaster")," to run any required fee logic."),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("inlineCode",{parentName:"p"},"Create2Factory")," refers to ",(0,i.kt)("a",{parentName:"p",href:"https://eips.ethereum.org/EIPS/eip-2470"},"EIP-2470: Singleton Factory"),". This is a permission-less contract used to deploy ",(0,i.kt)("inlineCode",{parentName:"p"},"Wallets")," with the same deterministic address on any chain.")),(0,i.kt)("h3",{id:"wallet"},"Wallet"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"Wallet")," is a user's ",(0,i.kt)("inlineCode",{parentName:"p"},"Contract Account"),". At minimum it needs to check whether or not it will accept a ",(0,i.kt)("inlineCode",{parentName:"p"},"UserOperation")," during the verification loop."),(0,i.kt)("p",null,"Additional features to support other wallet functions like social recovery and multi-operations can be added here too."),(0,i.kt)("h3",{id:"paymaster"},"Paymaster"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"Paymaster")," is another ",(0,i.kt)("inlineCode",{parentName:"p"},"Contract Account")," that handles any ",(0,i.kt)("inlineCode",{parentName:"p"},"UserOperation")," with sponsored transactions. It is required to do 2 things:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Check whether or not it will accept a ",(0,i.kt)("inlineCode",{parentName:"li"},"UserOperation")," during the verification loop."),(0,i.kt)("li",{parentName:"ol"},"Run any required fee logic in the execution loop.")),(0,i.kt)("p",null,"An example of a ",(0,i.kt)("inlineCode",{parentName:"p"},"Paymaster")," logic could be to withdraw a certain amount of ERC-20 tokens from the ",(0,i.kt)("inlineCode",{parentName:"p"},"Wallet")," after the ",(0,i.kt)("inlineCode",{parentName:"p"},"UserOperation")," is executed. This allows for a UX where users can pay for gas in any currency they choose."))}u.isMDXComponent=!0},2876:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/entrypoint-sequence-1471e67adfa90dc2993150ce759b8437.png"},7095:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/erc4337-architecture-simplified-04262752f6651a8e0a1400376401fb2a.png"}}]);